(this["webpackJsonpself-help-sheets"]=this["webpackJsonpself-help-sheets"]||[]).push([[7],{233:function(e,t,n){"use strict";n.r(t),n.d(t,"EntriesTableModelImpl",(function(){return f}));var s=n(2),r=n.n(s),i=n(3),a=n(12),o=n(9),c=n(10),d=n(81),u=n(43),h=n(78),_=n.n(h),p=n(94),l=n(55),y=n.n(l),f=function(){function e(t,n){var s=this;Object(a.a)(this,e),this._backendMap=t,this._authClient=n,this._disposed=!1,this._historyIndex=0,this._history=[],this._addNewItemMutex=new p.a,this._entries=new Map,this._isCreatingNewEntry=!1,this._settings=void 0,this._serializedSettings="",this._descriptions=new Map,this._subscriptions=new Set,this.addNewItemThrottled=_.a.throttle((function(){s.addNewItem()}),500),this.addNewItem=Object(i.a)(r.a.mark((function e(){var t,n,i,a=arguments;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],e.next=3,s._addNewItemMutex.acquire();case 3:if(n=e.sent,e.t0=s._tryFindVacantEntry(),e.t0){e.next=9;break}return e.next=8,s._createNewEntry();case 8:e.t0=e.sent;case 9:if(void 0!=(i=e.t0)){e.next=12;break}return e.abrupt("return");case 12:s.onUpdate(i.clear().setFocused(!0).setInitiallyCollapsed(!0).setCreationTime(new Date(Date.now())),t),n();case 14:case"end":return e.stop()}}),e)}))),this.sync=Object(i.a)(r.a.mark((function e(){var t,n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s._disposed){e.next=2;break}return e.abrupt("return");case 2:if(s._authClient.state===c.b.SIGNED_IN){e.next=7;break}return e.next=5,s._authClient.waitForStateChange();case 5:e.next=2;break;case 7:return e.next=9,s._backendMap.getAllKeys();case 9:if(t=e.sent,n=new Map,Array.from(t).forEach((function(e){var r,i,a;if(s._entries.has(e.id))r=s._entries.get(e.id);else if(e.description===u.b.DELETED)e.outdated=!1,r=new u.a(e.id,u.b.DELETED,"");else{var o,c;e.outdated=!0,r=new u.a(e.id,n.size<t.length-30?u.b.HIDDEN:u.b.LOADING,null!==(o=e.description)&&void 0!==o?o:""),s._descriptions.set(e.id,null!==(c=e.description)&&void 0!==c?c:"")}(y()(!!r),e.description!==s._descriptions.get(e.id))&&(r=r.setDescription(null!==(i=e.description)&&void 0!==i?i:""),s._descriptions.set(e.id,null!==(a=e.description)&&void 0!==a?a:""));n.set(e.id,r)})),i=[],void 0==s._settings&&i.push(s._fetchSettings()),t.reverse().forEach((function(e){e.outdated&&n.get(e.id).data!==u.b.HIDDEN&&i.push(s._fetch(e.id))})),s._entries=n,0!==s._entries.size){e.next=20;break}return e.next=19,s.addNewItem(!0);case 19:return e.abrupt("return");case 20:return s._onEntriesChanged(),e.next=23,Promise.all(i);case 23:case"end":return e.stop()}}),e)}))),this.onSettingsUpdate=_.a.debounce((function(e){s._settings=e,s._onEntriesChanged(),s._backendMap.setSettings(e.stringify())}),1e3),this.onUpdate=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(s._entries.has(e.key)){var n=s._entries.get(e.key);y()(!!n),e.data!==u.b.LOADING?(s._sendEntryToBackend(e),t||s._addHistoryItem(e),s._entries.set(e.key,e),s._onEntriesChanged()):n.data===u.b.HIDDEN&&(s._fetch(e.key),s._entries.set(e.key,e))}},this._syncLoop=Object(i.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s._disposed){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,s.sync();case 4:setTimeout(s._syncLoop,15e3);case 5:case"end":return e.stop()}}),e)}))),this._fetch=function(){var e=Object(i.a)(r.a.mark((function e(t){var n,i,a,o,c,d,h;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s._backendMap.get(t);case 2:if(n=e.sent,s._entries.has(t)){e.next=6;break}return console.error("Entry for fetch doesn't exist anymore. "+t),e.abrupt("return");case 6:if(void 0!==n){e.next=11;break}return console.error("Key "+t+" is missing"),void 0==(i=s._entries.get(t))||i.isDataLoaded()||(s._entries.delete(t),s._onEntriesChanged()),e.abrupt("return");case 11:if(e.prev=11,""!==n){e.next=18;break}a=new u.a(t,u.b.DELETED,""),s._addHistoryItem(a),s._entries.set(t,a),e.next=25;break;case 18:if((c=JSON.parse(n))===u.b.DELETED||null!=c.left&&null!=c.right){e.next=21;break}throw new Error("bad format "+n);case 21:c===u.b.DELETED&&s._descriptions.get(t)!==u.b.DELETED&&s._backendMap.setDescription(t,u.b.DELETED),d=new u.a(t,c,null!==(o=s._descriptions.get(t))&&void 0!==o?o:""),s._addHistoryItem(d),s._entries.set(t,d);case 25:e.next=33;break;case 27:return e.prev=27,e.t0=e.catch(11),console.error(e.t0.message+" "+t+" "+n),void 0==(h=s._entries.get(t))||h.isDataLoaded()||(s._entries.delete(t),s._onEntriesChanged()),e.abrupt("return");case 33:s._onEntriesChanged();case 34:case"end":return e.stop()}}),e,null,[[11,27]])})));return function(t){return e.apply(this,arguments)}}(),this._syncLoop()}return Object(o.a)(e,[{key:"dispose",value:function(){this._disposed=!0,this._subscriptions=new Set}},{key:"subscribe",value:function(e){this._subscriptions.add(e),this._entries.size>0&&e(this._getFilteredEntriesArray(),this._settings,{canUndo:!1,canRedo:!1})}},{key:"unsubscribe",value:function(e){this._subscriptions.delete(e)}},{key:"_tryFindVacantEntry",value:function(){var e=void 0;return this._entries.forEach((function(t){t.data===u.b.DELETED?void 0==e&&(e=t):e=void 0})),e}},{key:"_createNewEntry",value:function(){var e=Object(i.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._isCreatingNewEntry){e.next=2;break}return e.abrupt("return");case 2:return this._isCreatingNewEntry=!0,e.next=5,this._backendMap.createKey();case 5:return t=e.sent,y()(this._isCreatingNewEntry),this._isCreatingNewEntry=!1,n=new u.a(t,u.b.DELETED,""),this._entries.set(t,n),e.next=12,this._sendEntryToBackend(n);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"undo",value:function(){if(0!==this._historyIndex){this._historyIndex--;var e=this._history[this._historyIndex].old;e.data!==u.b.DELETED&&(e=e.setFocused(!0),this._history[this._historyIndex].new.data===u.b.DELETED&&(e=e.setInitiallyCollapsed(!0))),this._entries.set(e.key,e),this._sendEntryToBackend(e),this._onEntriesChanged()}}},{key:"redo",value:function(){if(!(this._historyIndex>=this._history.length)){var e=this._history[this._historyIndex++],t=e.new;t.data!==u.b.DELETED&&(t=t.setFocused(!0),e.old.data===u.b.DELETED&&(t=t.setInitiallyCollapsed(!0))),this._entries.set(t.key,t),this._sendEntryToBackend(t),this._onEntriesChanged()}}},{key:"_addHistoryItem",value:function(e){var t=this._entries.get(e.key);void 0!=t&&t.isDataLoaded()&&(this._history=this._history.slice(0,this._historyIndex),this._history.push({old:t,new:e}),this._historyIndex=this._history.length)}},{key:"_sendEntryToBackend",value:function(){var e=Object(i.a)(r.a.mark((function e(t){var n,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,t.description!==this._descriptions.get(t.key)&&(n=this._backendMap.setDescription(t.key,t.description),this._descriptions.set(t.key,t.description)),s=null,t.isDataLoaded()&&(s=this._backendMap.set(t.key,JSON.stringify(t.data))),e.next=6,Promise.all([n,s]);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchSettings",value:function(){var e=Object(i.a)(r.a.mark((function e(){var t;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._backendMap.getSettings();case 2:if(""!=(t=e.sent)){e.next=6;break}return this.onSettingsUpdate(new d.a("")),e.abrupt("return");case 6:if(this._serializedSettings!==t){e.next=8;break}return e.abrupt("return");case 8:this._serializedSettings=t,this._settings=new d.a(t),this._onEntriesChanged();case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getFilteredEntriesArray",value:function(){return Array.from(this._entries.values()).reverse().filter((function(e){return e.data!==u.b.DELETED&&null!==e.key}))}},{key:"_onEntriesChanged",value:function(){var e=this,t=this._getFilteredEntriesArray();this._subscriptions.forEach((function(n){n(t,e._settings,{canRedo:e._history.length>e._historyIndex,canUndo:e._history.length>0&&e._historyIndex>0})}))}}]),e}()}}]);
//# sourceMappingURL=7.4f704cd6.chunk.js.map