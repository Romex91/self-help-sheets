(this["webpackJsonpself-help-sheets"]=this["webpackJsonpself-help-sheets"]||[]).push([[6],{231:function(e,t,n){"use strict";n.r(t),n.d(t,"EntriesTableModelImpl",(function(){return b}));var s=n(2),r=n.n(s),i=n(3),a=n(9),o=n(10),c=n(20),d=n(19),u=n(31),h=n(11),l=n(81),_=n(47),p=n(72),y=n.n(p),f=n(96),b=function(e){Object(c.a)(n,e);var t=Object(d.a)(n);function n(e,s){var o;return Object(a.a)(this,n),console.assert(e instanceof u.a),(o=t.call(this)).addNewItemThrottled=y.a.throttle((function(){o.addNewItem()}),500),o.addNewItem=Object(i.a)(r.a.mark((function e(){var t,n,s,i=arguments;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]&&i[0],e.next=3,o._addNewItemMutex.acquire();case 3:if(n=e.sent,e.t0=o._tryFindVacantEntry(),e.t0){e.next=9;break}return e.next=8,o._createNewEntry();case 8:e.t0=e.sent;case 9:s=e.t0,o.onUpdate(s.clear().setFocused(!0).setInitiallyCollapsed(!0).setCreationTime(new Date(Date.now())),t),n();case 12:case"end":return e.stop()}}),e)}))),o.undo=function(){if(0!==o._historyIndex){o._historyIndex--;var e=o._history[o._historyIndex].old;e.data!==_.b.DELETED&&(e=e.setFocused(!0),o._history[o._historyIndex].new.data===_.b.DELETED&&(e=e.setInitiallyCollapsed(!0))),o._entries.set(e.key,e),o._sendEntryToBackend(e),o._onEntriesChanged()}},o.redo=function(){if(!(o._historyIndex>=o._history.length)){var e=o._history[o._historyIndex++],t=e.new;t.data!==_.b.DELETED&&(t=t.setFocused(!0),e.old.data===_.b.DELETED&&(t=t.setInitiallyCollapsed(!0))),o._entries.set(t.key,t),o._sendEntryToBackend(t),o._onEntriesChanged()}},o.sync=Object(i.a)(r.a.mark((function e(){var t,n,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!o._disposed){e.next=2;break}return e.abrupt("return");case 2:if(o._authClient.state===h.a.SIGNED_IN){e.next=7;break}return e.next=5,o._authClient.waitForStateChange();case 5:e.next=2;break;case 7:return e.next=9,o._backendMap.getAllKeys();case 9:if(t=e.sent,n=new Map,t.forEach((function(e){var s;o._entries.has(e.id)?s=o._entries.get(e.id):e.description===_.b.DELETED?(e.outdated=!1,s=new _.a(e.id).delete()):(e.outdated=!0,s=new _.a(e.id,n.size<t.length-30?_.b.HIDDEN:_.b.LOADING,e.description),o._descriptions.set(e.id,e.description)),e.description!==o._descriptions.get(e.id)&&(s=s.setDescription(e.description),o._descriptions.set(e.id,e.description)),n.set(e.id,s)})),s=[],null==o._settings&&s.push(o._fetchSettings()),t.reverse().forEach((function(e){e.outdated&&n.get(e.id).data!==_.b.HIDDEN&&s.push(o._fetch(e.id))})),o._entries.has(null)&&n.set(null,o._entries.get(null)),o._entries=n,0!==o._entries.size){e.next=21;break}return e.next=20,o.addNewItem(!0);case 20:return e.abrupt("return");case 21:return o._onEntriesChanged(),e.next=24,Promise.all(s);case 24:case"end":return e.stop()}}),e)}))),o.onSettingsUpdate=y.a.debounce((function(e){o._settings=e,o._onEntriesChanged(),o._backendMap.setSettings(e.stringify())}),1e3),o.onUpdate=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(o._entries.has(e.key)){var n=o._entries.get(e.key);e.data!==_.b.LOADING?(o._sendEntryToBackend(e),t||o._addHistoryItem(e),o._entries.set(e.key,e),o._onEntriesChanged()):n.data===_.b.HIDDEN&&(o._fetch(e.key),o._entries.set(e.key,e))}},o._disposed=!1,o._historyIndex=0,o._history=[],o._authClient=null,o._backendMap=null,o._addNewItemMutex=new f.a,o._entries=new Map,o._settings=null,o._descriptions=new Map,o._subscriptions=new Set,o._syncLoop=Object(i.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.sync();case 2:setTimeout(o._syncLoop,15e3);case 3:case"end":return e.stop()}}),e)}))),o._fetch=function(){var e=Object(i.a)(r.a.mark((function e(t){var n,s,i,a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o._backendMap.get(t);case 2:if(n=e.sent,o._entries.has(t)){e.next=6;break}return console.error("Entry for fetch doesn't exist anymore. "+t),e.abrupt("return");case 6:if(void 0!==n){e.next=11;break}return console.error("Key "+t+" is missing"),o._entries.delete(t),o._onEntriesChanged(),e.abrupt("return");case 11:if(e.prev=11,""!==n){e.next=18;break}s=new _.a(t).delete(),o._addHistoryItem(s),o._entries.set(t,s),e.next=25;break;case 18:if((i=JSON.parse(n))===_.b.DELETED||null!=i.left&&null!=i.right){e.next=21;break}throw new Error("bad format "+n);case 21:i===_.b.DELETED&&o._descriptions.get(t)!==_.b.DELETED&&o._backendMap.setDescription(t,_.b.DELETED),a=new _.a(t,i,o._descriptions.get(t)),o._addHistoryItem(a),o._entries.set(t,a);case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(11),console.error(e.t0.message+" "+t+" "+n),o._entries.get(t).isDataLoaded()||(o._entries.delete(t),o._descriptions.delete(t),o._backendMap.delete(t));case 31:o._onEntriesChanged();case 32:case"end":return e.stop()}}),e,null,[[11,27]])})));return function(t){return e.apply(this,arguments)}}(),o._backendMap=e,o._authClient=s,o._syncLoop(),o}return Object(o.a)(n,[{key:"dispose",value:function(){this._disposed=!0,this._subscriptions=new Set}},{key:"subscribe",value:function(e){this._subscriptions.add(e),this._entries.size>0&&e(this._getFilteredEntriesArray(),this._settings,{canUndo:!1,canRedo:!1})}},{key:"unsubscribe",value:function(e){this._subscriptions.delete(e)}},{key:"_tryFindVacantEntry",value:function(){var e=null;return this._entries.forEach((function(t){t.data===_.b.DELETED?null==e&&(e=t):e=null})),e}},{key:"_createNewEntry",value:function(){var e=Object(i.a)(r.a.mark((function e(){var t,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._entries.has(null)){e.next=2;break}return e.abrupt("return");case 2:return this._entries.set(null,new _.a(null).delete()),e.next=5,this._backendMap.createKey();case 5:if(t=e.sent,this._entries.has(null)){e.next=8;break}throw new Error("A null key should persist until the new key is created");case 8:return n=new _.a(t,this._entries.get(null).data,""),this._entries.set(t,n),e.next=12,this._sendEntryToBackend(n);case 12:return this._entries.delete(null),e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_addHistoryItem",value:function(e){if(null==e.key)throw new Error("null key shouldn't have value. There is no point to restore it.");this._entries.has(e.key)&&this._entries.get(e.key).isDataLoaded()&&(this._history=this._history.slice(0,this._historyIndex),this._history.push({old:this._entries.has(e.key)?this._entries.get(e.key):new _.a(e.key).delete(),new:e}),this._historyIndex=this._history.length)}},{key:"_sendEntryToBackend",value:function(){var e=Object(i.a)(r.a.mark((function e(t){var n,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,t.description!==this._descriptions.get(t.key)&&(n=this._backendMap.setDescription(t.key,t.description),this._descriptions.set(t.key,t.description)),s=null,t.isDataLoaded()&&(s=this._backendMap.set(t.key,JSON.stringify(t.data))),e.next=6,Promise.all([n,s]);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchSettings",value:function(){var e=Object(i.a)(r.a.mark((function e(){var t;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._backendMap.getSettings();case 2:if(t=e.sent,this._serializedSettings!==t){e.next=5;break}return e.abrupt("return");case 5:this._serializedSettings=t,this._settings=new l.a(t),this._onEntriesChanged();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getFilteredEntriesArray",value:function(){return Array.from(this._entries.values()).reverse().filter((function(e){return e.data!==_.b.DELETED&&null!==e.key}))}},{key:"_onEntriesChanged",value:function(){var e=this,t=this._getFilteredEntriesArray();this._subscriptions.forEach((function(n){n(t,e._settings,{canRedo:e._history.length>e._historyIndex,canUndo:e._history.length>0&&e._historyIndex>0})}))}}]),n}(n(86).a)}}]);
//# sourceMappingURL=6.794f64c9.chunk.js.map