(this["webpackJsonpself-help-sheets"]=this["webpackJsonpself-help-sheets"]||[]).push([[7],{235:function(e,t,n){"use strict";n.r(t),n.d(t,"EntriesTableModelImpl",(function(){return f}));var r=n(2),s=n.n(r),i=n(3),a=n(12),o=n(9),c=n(10),d=n(81),u=n(43),h=n(78),_=n.n(h),p=n(95),l=n(55),y=n.n(l),f=function(){function e(t,n){var r=this;Object(a.a)(this,e),this._backendMap=t,this._authClient=n,this._disposed=!1,this._historyIndex=0,this._history=[],this._addNewItemMutex=new p.a,this._entries=new Map,this._isCreatingNewEntry=!1,this._settings=void 0,this._serializedSettings="",this._descriptions=new Map,this._subscriptions=new Set,this.addNewItemThrottled=_.a.throttle((function(){r.addNewItem()}),500),this.addNewItem=Object(i.a)(s.a.mark((function e(){var t,n,i,a=arguments;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]&&a[0],e.next=3,r._addNewItemMutex.acquire();case 3:if(n=e.sent,e.t0=r._tryFindVacantEntry(),e.t0){e.next=9;break}return e.next=8,r._createNewEntry();case 8:e.t0=e.sent;case 9:if(void 0!=(i=e.t0)){e.next=12;break}return e.abrupt("return");case 12:r.onUpdate(i.clear().setFocused(!0).setInitiallyCollapsed(!0).setCreationTime(new Date(Date.now())),t),n();case 14:case"end":return e.stop()}}),e)}))),this.undo=function(){if(0!==r._historyIndex){r._historyIndex--;var e=r._history[r._historyIndex].old;e.data!==u.b.DELETED&&(e=e.setFocused(!0),r._history[r._historyIndex].new.data===u.b.DELETED&&(e=e.setInitiallyCollapsed(!0))),r._entries.set(e.key,e),r._sendEntryToBackend(e),r._onEntriesChanged()}},this.redo=function(){if(!(r._historyIndex>=r._history.length)){var e=r._history[r._historyIndex++],t=e.new;t.data!==u.b.DELETED&&(t=t.setFocused(!0),e.old.data===u.b.DELETED&&(t=t.setInitiallyCollapsed(!0))),r._entries.set(t.key,t),r._sendEntryToBackend(t),r._onEntriesChanged()}},this.sync=Object(i.a)(s.a.mark((function e(){var t,n,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r._disposed){e.next=2;break}return e.abrupt("return");case 2:if(r._authClient.state===c.b.SIGNED_IN){e.next=7;break}return e.next=5,r._authClient.waitForStateChange();case 5:e.next=2;break;case 7:return e.next=9,r._backendMap.getAllKeys();case 9:if(t=e.sent,n=new Map,Array.from(t).forEach((function(e){var s,i,a;if(r._entries.has(e.id))s=r._entries.get(e.id);else if(e.description===u.b.DELETED)e.outdated=!1,s=new u.a(e.id,u.b.DELETED,"");else{var o,c;e.outdated=!0,s=new u.a(e.id,n.size<t.length-30?u.b.HIDDEN:u.b.LOADING,null!==(o=e.description)&&void 0!==o?o:""),r._descriptions.set(e.id,null!==(c=e.description)&&void 0!==c?c:"")}(y()(!!s),e.description!==r._descriptions.get(e.id))&&(s=s.setDescription(null!==(i=e.description)&&void 0!==i?i:""),r._descriptions.set(e.id,null!==(a=e.description)&&void 0!==a?a:""));n.set(e.id,s)})),i=[],void 0==r._settings&&i.push(r._fetchSettings()),t.reverse().forEach((function(e){e.outdated&&n.get(e.id).data!==u.b.HIDDEN&&i.push(r._fetch(e.id))})),r._entries=n,0!==r._entries.size){e.next=20;break}return e.next=19,r.addNewItem(!0);case 19:return e.abrupt("return");case 20:return r._onEntriesChanged(),e.next=23,Promise.all(i);case 23:case"end":return e.stop()}}),e)}))),this.onSettingsUpdate=_.a.debounce((function(e){r._settings=e,r._onEntriesChanged(),r._backendMap.setSettings(e.stringify())}),1e3),this.onUpdate=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(r._entries.has(e.key)){var n=r._entries.get(e.key);y()(!!n),e.data!==u.b.LOADING?(r._sendEntryToBackend(e),t||r._addHistoryItem(e),r._entries.set(e.key,e),r._onEntriesChanged()):n.data===u.b.HIDDEN&&(r._fetch(e.key),r._entries.set(e.key,e))}},this._syncLoop=Object(i.a)(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r._disposed){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,r.sync();case 4:setTimeout(r._syncLoop,15e3);case 5:case"end":return e.stop()}}),e)}))),this._fetch=function(){var e=Object(i.a)(s.a.mark((function e(t){var n,i,a,o,c,d,h;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._backendMap.get(t);case 2:if(n=e.sent,r._entries.has(t)){e.next=6;break}return console.error("Entry for fetch doesn't exist anymore. "+t),e.abrupt("return");case 6:if(void 0!==n){e.next=11;break}return console.error("Key "+t+" is missing"),void 0==(i=r._entries.get(t))||i.isDataLoaded()||(r._entries.delete(t),r._onEntriesChanged()),e.abrupt("return");case 11:if(e.prev=11,""!==n){e.next=18;break}a=new u.a(t,u.b.DELETED,""),r._addHistoryItem(a),r._entries.set(t,a),e.next=25;break;case 18:if((c=JSON.parse(n))===u.b.DELETED||null!=c.left&&null!=c.right){e.next=21;break}throw new Error("bad format "+n);case 21:c===u.b.DELETED&&r._descriptions.get(t)!==u.b.DELETED&&r._backendMap.setDescription(t,u.b.DELETED),d=new u.a(t,c,null!==(o=r._descriptions.get(t))&&void 0!==o?o:""),r._addHistoryItem(d),r._entries.set(t,d);case 25:e.next=33;break;case 27:return e.prev=27,e.t0=e.catch(11),console.error(e.t0.message+" "+t+" "+n),void 0==(h=r._entries.get(t))||h.isDataLoaded()||(r._entries.delete(t),r._onEntriesChanged()),e.abrupt("return");case 33:r._onEntriesChanged();case 34:case"end":return e.stop()}}),e,null,[[11,27]])})));return function(t){return e.apply(this,arguments)}}(),this._syncLoop()}return Object(o.a)(e,[{key:"dispose",value:function(){this._disposed=!0,this._subscriptions=new Set}},{key:"subscribe",value:function(e){this._subscriptions.add(e),this._entries.size>0&&e(this._getFilteredEntriesArray(),this._settings,{canUndo:!1,canRedo:!1})}},{key:"unsubscribe",value:function(e){this._subscriptions.delete(e)}},{key:"_tryFindVacantEntry",value:function(){var e=void 0;return this._entries.forEach((function(t){t.data===u.b.DELETED?void 0==e&&(e=t):e=void 0})),e}},{key:"_createNewEntry",value:function(){var e=Object(i.a)(s.a.mark((function e(){var t,n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._isCreatingNewEntry){e.next=2;break}return e.abrupt("return");case 2:return this._isCreatingNewEntry=!0,e.next=5,this._backendMap.createKey();case 5:return t=e.sent,y()(this._isCreatingNewEntry),this._isCreatingNewEntry=!1,n=new u.a(t,u.b.DELETED,""),this._entries.set(t,n),e.next=12,this._sendEntryToBackend(n);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_addHistoryItem",value:function(e){var t=this._entries.get(e.key);void 0!=t&&t.isDataLoaded()&&(this._history=this._history.slice(0,this._historyIndex),this._history.push({old:t,new:e}),this._historyIndex=this._history.length)}},{key:"_sendEntryToBackend",value:function(){var e=Object(i.a)(s.a.mark((function e(t){var n,r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,t.description!==this._descriptions.get(t.key)&&(n=this._backendMap.setDescription(t.key,t.description),this._descriptions.set(t.key,t.description)),r=null,t.isDataLoaded()&&(r=this._backendMap.set(t.key,JSON.stringify(t.data))),e.next=6,Promise.all([n,r]);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchSettings",value:function(){var e=Object(i.a)(s.a.mark((function e(){var t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._backendMap.getSettings();case 2:if(""!=(t=e.sent)){e.next=6;break}return this.onSettingsUpdate(new d.a("")),e.abrupt("return");case 6:if(this._serializedSettings!==t){e.next=8;break}return e.abrupt("return");case 8:this._serializedSettings=t,this._settings=new d.a(t),this._onEntriesChanged();case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getFilteredEntriesArray",value:function(){return Array.from(this._entries.values()).reverse().filter((function(e){return e.data!==u.b.DELETED&&null!==e.key}))}},{key:"_onEntriesChanged",value:function(){var e=this,t=this._getFilteredEntriesArray();this._subscriptions.forEach((function(n){n(t,e._settings,{canRedo:e._history.length>e._historyIndex,canUndo:e._history.length>0&&e._historyIndex>0})}))}}]),e}()}}]);
//# sourceMappingURL=7.dd3937ff.chunk.js.map